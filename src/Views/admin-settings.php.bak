<?php
defined('ABSPATH') || exit;
// Read saved license if present
$opts = get_option('commeriq_license', ['licence_key' => '', 'domain_name' => '', 'activated_at' => '']);
$licence_key = isset($opts['licence_key']) ? esc_attr($opts['licence_key']) : '';
$domain_name = isset($opts['domain_name']) ? esc_attr($opts['domain_name']) : '';
$activated_at = isset($opts['activated_at']) ? $opts['activated_at'] : '';

// Temporary UI fallback: if nothing stored yet, show demo/demo and a demo activated date (UI only)
$demo_mode = false;
if (empty($licence_key) && empty($domain_name) && empty($activated_at)) {
    $licence_key = 'demo';
    $domain_name = 'demo';
    // show demo activated date but don't persist it to DB
    $activated_at = current_time('mysql');
    $demo_mode = true;
}

$is_active = !empty($activated_at);
?>
<div class="wrap">
    <style>
        /* Hide all tab contents until JS activates the proper one to avoid flicker/redirect on refresh */
        .commeriq-tab { display: none; }
    </style>
    <div id="commeriq-license-active" class="notice notice-success commeriq-license-active" style="display:none; padding:10px; margin-bottom:10px;">
        <span style="font-size:1.25em; margin-right:8px;">âœ…</span>
        <strong><?php esc_html_e('License Active', 'commeriq'); ?></strong>
    </div>
    <!-- Modal overlay for activation/removal feedback -->
    <div id="commeriq-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999;">
        <div id="commeriq-modal-box" style="width:420px; max-width:90%; margin:80px auto; background:#fff; border-radius:6px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.2); text-align:center;">
            <div id="commeriq-modal-icon" style="font-size:28px; margin-bottom:8px;">âŒ›</div>
            <h3 id="commeriq-modal-title" style="margin:0 0 8px; font-size:18px;">Processing</h3>
            <p id="commeriq-modal-message" style="margin:0 0 12px; color:#555;">Please wait...</p>
            <div style="margin-top:12px;"><button id="commeriq-modal-close" class="button" style="display:none;">Close</button></div>
        </div>
    </div>
    <h1><?php esc_html_e('CommerIQ', 'commeriq'); ?></h1>
    <p class="description"><?php esc_html_e('Smart AI for Product Description, Image Create & Product Comparison', 'commeriq'); ?></p>

    <h2 class="nav-tab-wrapper">
        <a class="nav-tab" href="#tab-licence"><?php esc_html_e('Licence', 'commeriq'); ?></a>
        <a class="nav-tab nav-tab-disabled" href="#tab-store"><?php esc_html_e('Store Analyzer', 'commeriq'); ?></a>
    </h2>

    <div id="tab-licence" class="commeriq-tab">
        <div id="commeriq-license-form">
            <?php // Ajax-only UI: do not use settings_fields() to avoid options.php POST and refresh resubmission ?>

            <div class="commeriq-license-box">
                <div class="commeriq-license-table" style="">
                    <div>
                        <div class="commeriq-box-header">
                            <?php if ( $is_active ) : ?>
                                <h2 class="commeriq-box-title"><span style="font-size:1.1em; margin-right:8px;">âœ…</span><?php echo esc_html__('License Active', 'commeriq'); ?></h2>
                                <p class="commeriq-box-subtext"><?php esc_html_e('Your license is active. AI features are available.', 'commeriq'); ?></p>
                            <?php else: ?>
                                <h2 class="commeriq-box-title"><span style="font-size:1.1em; margin-right:8px;">ðŸ”’</span><?php echo esc_html__('Activate Your License', 'commeriq'); ?></h2>
                                <p class="commeriq-box-subtext"><?php esc_html_e('Please activate your CommerIQ license to access AI features.', 'commeriq'); ?></p>
                            <?php endif; ?>
                        </div>
                    </div>

                    <div style="display:flex; gap:20px; margin-top:16px;">
                        <div style="flex:1;">
                            <label style="display:block; margin-bottom:8px; color:#717171;"><?php esc_html_e('License Key', 'commeriq'); ?></label>
                            <input type="text" id="licence_key" name="<?php echo \CommerIQ\Admin\SettingsPage::OPTION_KEY; ?>[licence_key]" value="<?php echo $licence_key; ?>" class="regular-text" style="width:100%; box-sizing:border-box; height:46px; background:#f5f5f5;" <?php echo $is_active ? 'readonly' : ''; ?> />
                        </div>
                        <div style="flex:1;">
                            <label style="display:block; margin-bottom:8px; color:#717171;"><?php esc_html_e('Domain', 'commeriq'); ?></label>
                            <input type="text" id="domain_name" name="<?php echo \CommerIQ\Admin\SettingsPage::OPTION_KEY; ?>[domain_name]" value="<?php echo $domain_name; ?>" class="regular-text" style="width:100%; box-sizing:border-box; height:46px; background:#f5f5f5;" <?php echo $is_active ? 'readonly' : ''; ?> />
                        </div>
                    </div>

                    <div class="commeriq-insert-after" style="height:0; margin-top:20px; padding:0;"></div>

                    <?php if ( $is_active ) : ?>
                        <div id="commeriq-activated-row" style="margin-bottom:20px;">
                            <label style="display:block; margin-bottom:8px; color:#717171;"><?php esc_html_e('Activated Date', 'commeriq'); ?></label>
                            <input type="text" id="commeriq-activated-date" readonly class="regular-text" style="width:100%; box-sizing:border-box; height:46px; background:#f5f5f5;" value="<?php echo esc_attr( date_i18n( get_option('date_format') . ' ' . get_option('time_format'), strtotime( $activated_at ) ) ); ?>" />
                        </div>
                    <?php endif; ?>

                    <div style="text-align:right; margin-top:20px">
                        <button type="button" class="button button-primary" id="commeriq-activate-license" <?php echo $is_active ? 'style="display:none;"' : ''; ?>><?php esc_html_e('Activate License', 'commeriq'); ?></button>
                        <button type="button" class="button commeriq-modify-license" id="commeriq-modify-license" style="margin-right:8px; <?php echo $is_active ? '' : 'display:none;'; ?>"><?php esc_html_e('Modify License', 'commeriq'); ?></button>
                        <button type="button" class="button button-secondary" id="commeriq-remove-license" style="background:#fff;border-color:#d9534f;color:#d9534f; <?php echo $is_active ? '' : 'display:none;'; ?>"><?php esc_html_e('Remove License', 'commeriq'); ?></button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="tab-store" class="commeriq-tab" style="display:none; margin-top:20px;">
       
        <?php
        // Retrieve values from WooCommerce settings automatically
        $woocommerce_values = ['country' => '', 'currency' => '', 'state' => ''];
        if (class_exists('CommerIQ\\Helpers\\Utils')) {
            $woocommerce_values = \CommerIQ\Helpers\Utils::derive_from_woocommerce();
        }
        ?>
        <div class="store-analyzer-box">
            <h3 class="store-analyzer-title"><?php esc_html_e('Store Analyzer', 'commeriq'); ?></h3>
            <p class="description"><?php esc_html_e('Configuration automatically retrieved from WooCommerce settings.', 'commeriq'); ?></p>
            <table class="form-table">
                <tr>
                    <th><?php esc_html_e('Country', 'commeriq'); ?></th>
                    <td><strong id="commeriq-country-display"><?php echo esc_html($woocommerce_values['country'] ?: 'Not Set'); ?></strong></td>
                </tr>
                <tr>
                    <th><?php esc_html_e('Currency', 'commeriq'); ?></th>
                    <td><strong id="commeriq-currency-display"><?php echo esc_html($woocommerce_values['currency'] ?: 'Not Set'); ?></strong></td>
                </tr>
                <tr>
                    <th><?php esc_html_e('State/Region', 'commeriq'); ?></th>
                    <td><strong id="commeriq-state-display"><?php echo esc_html($woocommerce_values['state'] ?: 'Not Set'); ?></strong></td>
                </tr>
                <?php if (!empty($woocommerce_values['address_1']) || !empty($woocommerce_values['address_2'])): ?>
                <tr>
                    <th><?php esc_html_e('Store Address', 'commeriq'); ?></th>
                    <td>
                        <strong id="commeriq-address-display">
                            <?php 
                            $address_parts = array_filter([
                                $woocommerce_values['address_1'],
                                $woocommerce_values['address_2']
                            ]);
                            echo esc_html(implode(', ', $address_parts));
                            ?>
                        </strong>
                    </td>
                </tr>
                <?php endif; ?>
            </table>
            <p class="description" style="margin-top: 15px;">
                <?php esc_html_e('To change these values, please update your WooCommerce settings at', 'commeriq'); ?>
                <a href="<?php echo esc_url(admin_url('admin.php?page=wc-settings')); ?>"><?php esc_html_e('WooCommerce â†’ Settings', 'commeriq'); ?></a>
            </p>
        </div>
    </div>
</div>

<script>
    (function(){
        const tabs = document.querySelectorAll('.nav-tab');

        function activateTabById(id) {
            if (!id) return;
            const selector = '.nav-tab[href="#' + id + '"]';
            const tab = document.querySelector(selector);
            if (!tab) return;
            tabs.forEach(function(x){ x.classList.remove('nav-tab-active'); });
            tab.classList.add('nav-tab-active');
            document.querySelectorAll('.commeriq-tab').forEach(function(c){ c.style.display = 'none'; });
            const el = document.getElementById(id);
            if (el) el.style.display = 'block';
        }

        tabs.forEach(function(t){
            t.addEventListener('click', function(e){
                e.preventDefault();
                const id = t.getAttribute('href').substring(1);
                activateTabById(id);
                // persist in URL hash (no history entry) and localStorage as a fallback
                try { history.replaceState(null, '', '#' + id); } catch(e) { window.location.hash = '#' + id; }
                try { localStorage.setItem('commeriq_active_tab', id); } catch(e) { /* ignore */ }
            });
        });

        // Restore tab from URL hash if present, otherwise try localStorage. If none exist, show server default 'tab-licence'.
        var initialHash = (window.location.hash || '').replace('#','');
        if (initialHash) {
            activateTabById(initialHash);
        } else {
            try {
                var stored = localStorage.getItem('commeriq_active_tab') || '';
                if (stored) {
                    activateTabById(stored);
                } else {
                    // no stored tab, fall back to licence tab (server default)
                    activateTabById('tab-licence');
                }
            } catch(e) {
                activateTabById('tab-licence');
            }
        }
    })();
</script>
    
    <!-- Activation / Processing Modal -->
    <div id="commeriq-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:9999;">
        <div style="max-width:520px; margin:80px auto; background:#fff; padding:20px; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.2);">
            <div style="display:flex; align-items:center; gap:12px;">
                <div id="commeriq-modal-icon" style="font-size:28px;">âŒ›</div>
                <div style="flex:1;">
                    <div id="commeriq-modal-title" style="font-weight:600; font-size:18px;">Processing</div>
                    <div id="commeriq-modal-message" style="color:#666; margin-top:6px;">Please waitâ€¦</div>
                </div>
                <div>
                    <button id="commeriq-modal-close" class="button" style="display:none;">Close</button>
                </div>
            </div>
        </div>
    </div>