<?php
namespace CommerIQ;

defined('ABSPATH') || exit;

class Loader
{
    public static function init()
    {
        add_action('admin_menu', [__CLASS__, 'register_admin_pages']);
        add_action('add_meta_boxes', [__CLASS__, 'register_meta_boxes']);
        add_action('admin_enqueue_scripts', [__CLASS__, 'admin_assets']);
        add_action('wp_ajax_commeriq_run_comparison', [__CLASS__, 'ajax_run_comparison']);
        add_action('wp_ajax_commeriq_retrieve_store', [__CLASS__, 'ajax_retrieve_store']);
        add_action('wp_ajax_commeriq_save_store', [__CLASS__, 'ajax_save_store']);
        add_action('wp_ajax_commeriq_activate_license', [__CLASS__, 'ajax_activate_license']);
        add_action('wp_ajax_commeriq_remove_license', [__CLASS__, 'ajax_remove_license']);

        // If SettingsPage exists as a file, include and let it register itself on admin_init
        $settings_file = COMMERIQ_PLUGIN_DIR . 'src/Admin/SettingsPage.php';
        if (file_exists($settings_file)) {
            require_once $settings_file;
            if (class_exists('CommerIQ\\Admin\\SettingsPage')) {
                \CommerIQ\Admin\SettingsPage::register();
            }
        }

        // Register product editor helpers (buttons, panels)
        $product_editor_file = COMMERIQ_PLUGIN_DIR . 'src/Admin/ProductEditor.php';
        if (file_exists($product_editor_file)) {
            require_once $product_editor_file;
            if (class_exists('CommerIQ\\Admin\\ProductEditor')) {
                \CommerIQ\Admin\ProductEditor::register();
            }
        }

        // Do not auto-create or activate a license here. License activation is explicit
        // and will be persisted via the AJAX activate/remove endpoints.

        // StoreConfiguration removed; store values are derived from WooCommerce via Utils

        // Register REST endpoints if available
        $rest_file = COMMERIQ_PLUGIN_DIR . 'src/REST/RestEndpoints.php';
        if (file_exists($rest_file)) {
            require_once $rest_file;
            if (class_exists('CommerIQ\\REST\\RestEndpoints')) {
                \CommerIQ\REST\RestEndpoints::register();
            }
        }

        // Register hourly sync handler if job exists
        $job_file = COMMERIQ_PLUGIN_DIR . 'src/Jobs/CommerIQ_SyncJob.php';
        if (file_exists($job_file)) {
            require_once $job_file;
            if (class_exists('CommerIQ\\Jobs\\CommerIQ_SyncJob')) {
                add_action('commeriq_hourly_sync', ['\\CommerIQ\\Jobs\\CommerIQ_SyncJob', 'run']);
            }
        }

        // ReportsPage registration intentionally removed (no reports submenu)
    }

    public static function admin_assets($hook)
    {
        // Ensure WP dashicons are available for icon buttons
        wp_enqueue_style('dashicons');
        wp_enqueue_style('commeriq-admin', COMMERIQ_PLUGIN_URL . 'assets/css/commeriq-admin.css', [], COMMERIQ_VERSION);
        wp_enqueue_script('commeriq-admin', COMMERIQ_PLUGIN_URL . 'assets/js/commeriq-admin.js', ['jquery'], COMMERIQ_VERSION, true);
        wp_localize_script('commeriq-admin', 'commeriqAdmin', [
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('commeriq_product_nonce'),
            'retrieve_nonce' => wp_create_nonce('commeriq_retrieve_nonce'),
            'license_nonce' => wp_create_nonce('commeriq_license_nonce'),
        ]);
    }

    public static function register_admin_pages()
    {
        if (!current_user_can('manage_woocommerce')) {
            return;
        }
        // Register as a submenu under WooCommerce
        if (function_exists('add_submenu_page')) {
            add_submenu_page('woocommerce', 'CommerIQ', 'CommerIQ', 'manage_woocommerce', 'commeriq-settings', [__CLASS__, 'render_settings_page']);
        } else {
            // fallback to top-level if WooCommerce menu not present
            add_menu_page('CommerIQ', 'CommerIQ', 'manage_woocommerce', 'commeriq-settings', [__CLASS__, 'render_settings_page'], 'dashicons-chart-line');
        }
    }

    public static function render_settings_page()
    {
        if (!current_user_can('manage_woocommerce')) {
            wp_die(__('Unauthorized', 'commeriq'));
        }
        require_once COMMERIQ_PLUGIN_DIR . 'src/Views/admin-settings.php';
    }

    public static function register_meta_boxes()
    {
        add_meta_box('commeriq_product_panel', 'CommerIQ Insights', [__CLASS__, 'render_product_panel'], 'product', 'side', 'core');
    }

    public static function render_product_panel($post)
    {
        require_once COMMERIQ_PLUGIN_DIR . 'src/Views/admin-product-panel.php';
    }

    public static function ajax_run_comparison()
    {
        check_ajax_referer('commeriq_product_nonce', '_nonce');
        if (!current_user_can('manage_woocommerce')) {
            wp_send_json_error(['message' => 'Unauthorized'], 403);
        }
        wp_send_json_success(['message' => 'Not implemented']);
    }

    public static function ajax_retrieve_store()
    {
        check_ajax_referer('commeriq_retrieve_nonce', '_nonce');
        if (!current_user_can('manage_woocommerce')) {
            wp_send_json_error(['message' => 'Unauthorized'], 403);
        }

        // Prefer WooCommerce-derived values when available
        if (class_exists('CommerIQ\\Helpers\\Utils')) {
            $derived = \CommerIQ\Helpers\Utils::derive_from_woocommerce();
            $out = [
                'country' => isset($derived['country']) ? $derived['country'] : '',
                'currency' => isset($derived['currency']) ? $derived['currency'] : '',
                'state' => isset($derived['state']) ? $derived['state'] : '',
                'source' => 'woocommerce',
            ];
            wp_send_json_success($out);
        }

        // Fallback to stored option (use commeriq_store_config for consistency with settings page)
        $stored = get_option('commeriq_store_config', ['country' => '', 'currency' => '', 'state' => '', 'address_1' => '', 'address_2' => '']);
        $out = [
            'country' => isset($stored['country']) ? $stored['country'] : '',
            'currency' => isset($stored['currency']) ? $stored['currency'] : '',
            'state' => isset($stored['state']) ? $stored['state'] : '',
            'address_1' => isset($stored['address_1']) ? $stored['address_1'] : '',
            'address_2' => isset($stored['address_2']) ? $stored['address_2'] : '',
            'source' => (!empty($stored['country']) || !empty($stored['currency']) || !empty($stored['state'])) ? 'stored' : 'empty',
        ];
        wp_send_json_success($out);
    }

    public static function ajax_save_store()
    {
        check_ajax_referer('commeriq_retrieve_nonce', '_nonce');
        if (!current_user_can('manage_woocommerce')) {
            wp_send_json_error(['message' => 'Unauthorized'], 403);
        }

        $vals = isset($_POST['store_values']) && is_array($_POST['store_values']) ? wp_unslash($_POST['store_values']) : [];
        $out = [
            'country' => isset($vals['country']) ? sanitize_text_field($vals['country']) : '',
            'currency' => isset($vals['currency']) ? sanitize_text_field($vals['currency']) : '',
            'state' => isset($vals['state']) ? sanitize_text_field($vals['state']) : '',
            'address_1' => isset($vals['address_1']) ? sanitize_text_field($vals['address_1']) : '',
            'address_2' => isset($vals['address_2']) ? sanitize_text_field($vals['address_2']) : '',
        ];

        // Persist into commeriq_store_config so the settings view reads the same data
        update_option('commeriq_store_config', $out);
        wp_send_json_success($out);
    }

    public static function ajax_activate_license()
    {
        check_ajax_referer('commeriq_license_nonce', 'nonce');
        if (!current_user_can('manage_woocommerce')) {
            wp_send_json_error(['message' => 'Unauthorized'], 403);
        }
        // Accept either a posted 'license' array or individual fields (compatibility with different serializers)
        $vals = [];
        if (isset($_POST['license']) && is_array($_POST['license'])) {
            $vals = wp_unslash($_POST['license']);
        } else {
            // Fallback to individual post fields
            $vals = [
                'licence_key' => isset($_POST['licence_key']) ? wp_unslash($_POST['licence_key']) : '',
                'domain_name' => isset($_POST['domain_name']) ? wp_unslash($_POST['domain_name']) : '',
            ];
        }

        $licence_key = isset($vals['licence_key']) ? sanitize_text_field($vals['licence_key']) : '';
        $domain_name = isset($vals['domain_name']) ? sanitize_text_field($vals['domain_name']) : '';

        // For now accept demo/demo as valid activation (API will be integrated later)
        $activated_at = current_time('mysql');
        $payload = ['licence_key' => $licence_key, 'domain_name' => $domain_name, 'activated_at' => $activated_at];
        update_option('commeriq_license', $payload);

        // Prepare a formatted date for the client
        $activated_at_formatted = date_i18n( get_option('date_format') . ' ' . get_option('time_format'), strtotime( $activated_at ) );

        wp_send_json_success([
            'message' => 'License activated',
            'licence_key' => $licence_key,
            'domain_name' => $domain_name,
            'activated_at' => $activated_at,
            'activated_at_formatted' => $activated_at_formatted,
        ]);
    }

    public static function ajax_remove_license()
    {
        check_ajax_referer('commeriq_license_nonce', 'nonce');
        if (!current_user_can('manage_woocommerce')) {
            wp_send_json_error(['message' => 'Unauthorized'], 403);
        }

        // Clear stored licence and activation timestamp
        update_option('commeriq_license', ['licence_key' => '', 'domain_name' => '', 'activated_at' => '']);

        wp_send_json_success(['message' => 'License removed']);
    }
}